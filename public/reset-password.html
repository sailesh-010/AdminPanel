<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password - Sajha System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style> 
    body { font-family: 'Poppins', sans-serif; }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .step-indicator {
      display: flex;
      align-items: center;
      margin-bottom: 2rem;
    }
    .step {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background-color: #e5e7eb;
      color: #6b7280;
      font-weight: 600;
      font-size: 0.875rem;
    }
    .step.active {
      background-color: #ef4444;
      color: white;
    }
    .step.completed {
      background-color: #10b981;
      color: white;
    }
    .step-line {
      flex: 1;
      height: 2px;
      background-color: #e5e7eb;
      margin: 0 0.5rem;
    }
    .step-line.completed {
      background-color: #10b981;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-[#EAF4F8] via-[#F3FAFC] to-white min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
  
  <!-- Header with Logo -->
  <div class="bg-gradient-to-r from-red-500 to-red-600 p-6 text-center text-white">
    <div class="w-16 h-16 mx-auto mb-3">
      <img src="/assest/images/logo.png" alt="Sajha System Logo" class="w-full h-full object-contain filter brightness-0 invert">
    </div>
    <h1 class="text-2xl font-bold">Sajha System</h1>
    <p class="text-red-100 text-sm mt-1">"‡§∏‡§æ‡§ù‡§æ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§®, ‡§∏‡§ú‡§ø‡§≤‡•ã ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞"</p>
  </div>

  <!-- Content -->
  <div class="p-8">
    
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div id="step1" class="step active">1</div>
      <div id="step1-line" class="step-line"></div>
      <div id="step2" class="step">2</div>
    </div>

    <!-- Success/Error Messages -->
    <div id="message" class="hidden mb-6 p-4 rounded-lg text-sm font-medium"></div>

    <!-- Request OTP Form (Step 1) -->
    <div id="requestForm" class="space-y-6">
      <div class="text-center mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-2">Forgot Your Password?</h2>
        <p class="text-gray-600 text-sm">No worries! Enter your email address below and we'll send you an OTP code to reset your password.</p>
      </div>
      
      <div>
        <label class="block text-gray-700 font-medium mb-2">Email Address</label>
        <input
          id="email"
          type="email"
          placeholder="you@example.com"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent transition"
          required/>
      </div>

      <button
        id="requestBtn"
        onclick="requestPasswordReset()"
        class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 rounded-lg font-semibold hover:from-red-600 hover:to-red-700 transition-all focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
        <span id="requestBtnText">Send OTP Code</span>
      </button>
    </div>

    <!-- Enter OTP and Reset Password Form (Step 2) -->
    <div id="resetForm" class="hidden space-y-6">
      <div class="text-center mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-2">Enter OTP Code</h2>
        <p class="text-gray-600 text-sm">We've sent a 6-digit OTP code to your email. Enter it below to verify and reset your password.</p>
      </div>
      
      <div>
        <label class="block text-gray-700 font-medium mb-2">OTP Code</label>
        <input
          id="otpCode"
          type="text"
          placeholder="Enter 6-digit code"
          maxlength="6"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent transition text-center text-lg font-mono tracking-widest"
          required/>
        <div class="mt-1 text-xs text-gray-500">
          Check your email for the 6-digit code
        </div>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-2">New Password</label>
        <input
          id="password"
          type="password"
          placeholder="Enter your new password"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent transition"
          required/>
        <div class="mt-1 text-xs text-gray-500">
          Must be at least 6 characters long
        </div>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-2">Confirm Password</label>
        <input
          id="confirmPassword"
          type="password"
          placeholder="Confirm your new password"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:border-transparent transition"
          required/>
      </div>

      <button
        id="resetBtn"
        onclick="resetPassword()"
        class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 rounded-lg font-semibold hover:from-red-600 hover:to-red-700 transition-all focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2">
        <span id="resetBtnText">Reset Password</span>
      </button>
    </div>

    <p class="text-center text-gray-600 text-sm mt-8">
      <a href="/login" class="text-red-500 hover:underline font-medium flex items-center justify-center">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Login
      </a>
    </p>
  </div>
</div>

<script>
// Utility functions for better UX
function showMessage(message, type = 'error') {
  const messageDiv = document.getElementById('message');
  messageDiv.className = `mb-6 p-4 rounded-lg text-sm font-medium ${type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : type === 'warning' ? 'bg-yellow-100 border border-yellow-400 text-yellow-700' : 'bg-red-100 border border-red-400 text-red-700'}`;
  messageDiv.textContent = message;
  messageDiv.classList.remove('hidden');
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    messageDiv.classList.add('hidden');
  }, 5000);
}

function setLoading(buttonId, textId, isLoading) {
  const button = document.getElementById(buttonId);
  const text = document.getElementById(textId);
  
  if (isLoading) {
    button.disabled = true;
    button.classList.add('opacity-75', 'cursor-not-allowed');
    text.innerHTML = '<span class="loading"></span> Processing...';
  } else {
    button.disabled = false;
    button.classList.remove('opacity-75', 'cursor-not-allowed');
    text.textContent = buttonId === 'requestBtn' ? 'Send OTP Code' : 'Reset Password';
  }
}

function updateStep(stepNumber) {
  if (stepNumber === 2) {
    document.getElementById('step1').classList.add('completed');
    document.getElementById('step1-line').classList.add('completed');
    document.getElementById('step2').classList.add('active');
  }
}

let currentEmail = '';

async function requestPasswordReset() {
  const email = document.getElementById('email').value.trim();

  if (!email) {
    showMessage('Please enter your email address', 'error');
    return;
  }

  if (!email.includes('@') || !email.includes('.')) {
    showMessage('Please enter a valid email address', 'error');
    return;
  }

  setLoading('requestBtn', 'requestBtnText', true);

  try {
    const res = await fetch('/api/auth/forgot-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });

    const data = await res.json();

    if (res.ok) {
      currentEmail = email;
      showMessage('‚úÖ OTP code has been sent to your email! Check your inbox and enter the 6-digit code.', 'success');
      
      // Move to step 2
      updateStep(2);
      document.getElementById('requestForm').classList.add('hidden');
      document.getElementById('resetForm').classList.remove('hidden');
      
      document.getElementById('email').value = '';
    } else {
      showMessage(data.message || 'Failed to send OTP code. Please try again.', 'error');
    }
  } catch (err) {
    console.error('Request failed:', err);
    showMessage('Network error. Please check your connection and try again.', 'error');
  } finally {
    setLoading('requestBtn', 'requestBtnText', false);
  }
}

async function resetPassword() {
  const otpCode = document.getElementById('otpCode').value.trim();
  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;

  if (!otpCode) {
    showMessage('Please enter the OTP code', 'error');
    return;
  }

  if (otpCode.length !== 6) {
    showMessage('OTP code must be 6 digits', 'error');
    return;
  }

  if (!password) {
    showMessage('Please enter your new password', 'error');
    return;
  }

  if (password.length < 6) {
    showMessage('Password must be at least 6 characters long', 'error');
    return;
  }

  if (password !== confirmPassword) {
    showMessage('Passwords do not match. Please check and try again.', 'error');
    return;
  }

  setLoading('resetBtn', 'resetBtnText', true);

  try {
    // Use the OTP code as the token for Supabase
    const res = await fetch('/api/auth/reset-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: otpCode, password: password })
    });

    const data = await res.json();

    if (res.ok) {
      showMessage('üéâ Password reset successful! Redirecting to login...', 'success');
      
      // Complete the step indicator
      document.getElementById('step2').classList.add('completed');
      
      // Redirect after a short delay
      setTimeout(() => {
        window.location.href = '/login';
      }, 2000);
    } else {
      // Handle specific error codes
      if (data.code === 'TOKEN_EXPIRED' || data.code === 'OTP_EXPIRED') {
        showMessage('‚ùå This OTP code has expired. Please request a new one.', 'error');
        // Go back to step 1
        document.getElementById('requestForm').classList.remove('hidden');
        document.getElementById('resetForm').classList.add('hidden');
        document.getElementById('step1').classList.remove('completed');
        document.getElementById('step1-line').classList.remove('completed');
        document.getElementById('step2').classList.remove('active');
      } else if (data.code === 'INVALID_OTP') {
        showMessage('‚ùå Invalid OTP code. Please check and try again.', 'error');
      } else {
        showMessage(data.message || 'Failed to reset password. Please try again.', 'error');
      }
    }
  } catch (err) {
    console.error('Reset failed:', err);
    showMessage('Network error. Please check your connection and try again.', 'error');
  } finally {
    setLoading('resetBtn', 'resetBtnText', false);
  }
}
</script>

</body>
</html>